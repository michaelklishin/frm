# Instructions for AI Agents

## Overview

This is `frm`, a RabbitMQ version switcher based on the [generic binary builds](https://www.rabbitmq.com/docs/install-generic-unix).

## Repository Layout

This is a Rust workspace with three crates:

 * `crates/frm-bin`: the CLI binary, `frm`
 * `crates/rabbitmq-conf`: a library for parsing and manipulating `rabbitmq.conf` files, a partial port of RabbitMQ's (Erlang's) [`cuttlefish`](https://github.com/kyorai/cuttlefish)
 * `crates/rabbitmq-versioning`: RabbitMQ version parsing, comparison, and artifact URL generation

### The `frm-bin` Crate

 * `main.rs`: entry point
 * `cli.rs`: `clap`-based CLI parser
 * `commands/`: command handlers (install, uninstall, list, conf, etc.)
 * `common/`: a shared internal library (with submodules: `cli_tools`, `env_vars`, `http`, `urls`)
 * `paths.rs`: internal directory structure and operations
 * `download.rs`: download and extraction of the generic binary builds
 * `releases.rs`: GitHub releases API integration
 * `timestamps.rs`, `versions_file.rs`: map versions to installation time, making time-based alpha release cleanup trivial

### The `rabbitmq-conf` Crate

Implements a `rabbitmq.conf` parser plus provides configuration key manipulation features.

 * `conf.rs`: [`winnow`](https://docs.rs/winnow)-based parser for `rabbitmq.conf` files (the [`cuttlefish`](https://github.com/kyorai/cuttlefish) ini-like format)
 * `keys.rs`: key validation against known RabbitMQ Cuttlefish schemas (both core `rabbit.schema` and those coming from all tier-1 plugins)
 * `errors.rs`: library error types

### The `rabbitmq-versioning` Crate

Deals with RabbitMQ version strings, including pre-release and Tanzu RabbitMQ versions.

 * `version.rs`: RabbitMQ version parsing and comparison
 * `prerelease.rs`: prerelease version types (alpha, beta, rc)
 * `errors.rs`: library error types

## Build and Test

```bash
cargo build

cargo fmt --all

cargo nextest run --all-features
cargo clippy --all-features
```

To [filter](https://nexte.st/docs/filtersets/) tests with `cargo nextest`:

```bash
cargo nextest run -E "test(test_name)"
```

## Target Rust Version

 * This tool targets very recent Rust (such as `1.93`)

## Rust Code Style

 * Prefer top-level `use` statements (imports) over fully-qualified names, e.g. `Display` or `fmt::Display` with a `use` statement, over `std::fmt::Display`
 * Never use function-local `use` statements (imports)
 * Add tests to the modules under `tests`, never in the implementation files
 * At the end of each task, run `cargo fmt --all`
 * At the end of each task, run `cargo clippy --all` and fix any warnings it might emit

## Comments

 * Only add very important comments, both in tests and in the implementation

## Git Instructions

 * Never add yourself to the list of commit co-authors
 * Never mention yourself in commit messages in any way (no "Generated by", no AI tool links, etc)

## Style Guide

 * Never add full stops to Markdown list items

## After Completing a Task

### Iterative Reviews

After completing a task, perform up to twenty iterative reviews of your changes.
In every iteration, look for meaningful improvements that were missed, for gaps in test coverage,
and for deviations from the instructions in this file.

If no meaningful improvements are found for three iterations in a row,
report it and stop iterating.
